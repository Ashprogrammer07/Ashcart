{"ast":null,"code":"import{Fragment,useEffect}from\"react\";import MetaData from\"../layouts/MetaData\";import{useElements,CardNumberElement,CardExpiryElement,CardCvcElement,useStripe}from\"@stripe/react-stripe-js\";import{useDispatch,useSelector}from\"react-redux\";import{useNavigate}from\"react-router-dom\";import{validateShipping}from\"./shipping\";import axios from\"axios\";import{toast}from\"react-toastify\";import{createOrder}from\"../../actions/orderActions\";import{clearorderError}from\"../../slices/orderSlices\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export default function Payment(){const stripe=useStripe();const elements=useElements();const dispatch=useDispatch();const navigate=useNavigate();const rawOrderInfo=sessionStorage.getItem(\"orderInfo\");const orderInfo=rawOrderInfo?JSON.parse(rawOrderInfo):null;const{user}=useSelector(state=>state.authState);const{items:cartItems,shippingInfo}=useSelector(state=>state.cartState);const{error:ordererror}=useSelector(state=>state.orderState);useEffect(()=>{if(!orderInfo||!orderInfo.totalPrice){toast.error(\"Session expired or invalid order. Redirecting...\");navigate(\"/cart\");return;}validateShipping(shippingInfo,navigate);if(ordererror){toast(ordererror,{type:\"error\",position:'bottom-center',onOpen:()=>{dispatch(clearorderError());}});}},[orderInfo,shippingInfo,navigate]);if(!orderInfo||!orderInfo.totalPrice)return null;const paymentData={amount:Math.round(orderInfo.totalPrice*100),shipping:{name:user.name,address:{city:shippingInfo.city,postal_code:shippingInfo.postalCode,country:shippingInfo.country,state:shippingInfo.state,line1:shippingInfo.address},phone:shippingInfo.phoneno}};const order={orderItems:cartItems,shippingInfo,itemsPrice:orderInfo.itemsPrice,shippingPrice:orderInfo.shippingPrice,taxPrice:orderInfo.taxPrice,totalPrice:orderInfo.totalPrice};const onsubmitHandler=async e=>{e.preventDefault();document.querySelector(\"#pay_btn\").disabled=true;try{const{data}=await axios.post(\"/api/v1/payment/process\",paymentData);const clientSecret=data.client_secret;const result=await stripe.confirmCardPayment(clientSecret,{payment_method:{card:elements.getElement(CardNumberElement),billing_details:{name:user.name,email:user.email}}});if(result.error){toast(result.error.message,{position:\"bottom-center\",type:\"error\"});document.querySelector(\"#pay_btn\").disabled=false;}else{if(result.paymentIntent.status===\"succeeded\"){toast(\"Payment success!\",{type:\"success\",position:\"bottom-center\"});order.paymentInfo={id:result.paymentIntent.id,status:result.paymentIntent.status};dispatch(createOrder(order));navigate(\"/order/success\");}else{toast(\"Payment failed. Please try again.\",{type:\"warning\",position:\"bottom-center\"});}}}catch(error){var _error$response,_error$response$data;toast(((_error$response=error.response)===null||_error$response===void 0?void 0:(_error$response$data=_error$response.data)===null||_error$response$data===void 0?void 0:_error$response$data.message)||\"Payment failed\",{type:\"error\",position:\"bottom-center\"});document.querySelector(\"#pay_btn\").disabled=false;}};return/*#__PURE__*/_jsxs(Fragment,{children:[/*#__PURE__*/_jsx(MetaData,{title:\"Payment\"}),/*#__PURE__*/_jsx(\"div\",{className:\"row wrapper\",children:/*#__PURE__*/_jsx(\"div\",{className:\"col-10 col-lg-5\",children:/*#__PURE__*/_jsxs(\"form\",{className:\"shadow-lg\",onSubmit:onsubmitHandler,children:[/*#__PURE__*/_jsx(\"h1\",{className:\"mb-4\",children:\"Card Info\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"form-group\",children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"card_num_field\",children:\"Card Number\"}),/*#__PURE__*/_jsx(CardNumberElement,{id:\"card_num_field\",className:\"form-control\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"form-group\",children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"card_exp_field\",children:\"Card Expiry\"}),/*#__PURE__*/_jsx(CardExpiryElement,{id:\"card_exp_field\",className:\"form-control\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"form-group\",children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"card_cvc_field\",children:\"Card CVC\"}),/*#__PURE__*/_jsx(CardCvcElement,{id:\"card_cvc_field\",className:\"form-control\"})]}),/*#__PURE__*/_jsxs(\"button\",{id:\"pay_btn\",type:\"submit\",className:\"btn btn-block py-3\",children:[\"Pay - $\",orderInfo.totalPrice]})]})})})]});}","map":{"version":3,"names":["Fragment","useEffect","MetaData","useElements","CardNumberElement","CardExpiryElement","CardCvcElement","useStripe","useDispatch","useSelector","useNavigate","validateShipping","axios","toast","createOrder","clearorderError","jsx","_jsx","jsxs","_jsxs","Payment","stripe","elements","dispatch","navigate","rawOrderInfo","sessionStorage","getItem","orderInfo","JSON","parse","user","state","authState","items","cartItems","shippingInfo","cartState","error","ordererror","orderState","totalPrice","type","position","onOpen","paymentData","amount","Math","round","shipping","name","address","city","postal_code","postalCode","country","line1","phone","phoneno","order","orderItems","itemsPrice","shippingPrice","taxPrice","onsubmitHandler","e","preventDefault","document","querySelector","disabled","data","post","clientSecret","client_secret","result","confirmCardPayment","payment_method","card","getElement","billing_details","email","message","paymentIntent","status","paymentInfo","id","_error$response","_error$response$data","response","children","title","className","onSubmit","htmlFor"],"sources":["/home/ashwin/Documents/GitHub/Ashcart/frontend/src/components/cart/payment.js"],"sourcesContent":["import { Fragment, useEffect } from \"react\";\nimport MetaData from \"../layouts/MetaData\";\nimport {\n  useElements,\n  CardNumberElement,\n  CardExpiryElement,\n  CardCvcElement,\n  useStripe\n} from \"@stripe/react-stripe-js\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { useNavigate } from \"react-router-dom\";\nimport { validateShipping } from \"./shipping\";\nimport axios from \"axios\";\nimport { toast } from \"react-toastify\";\nimport { createOrder } from \"../../actions/orderActions\";\nimport { clearorderError } from \"../../slices/orderSlices\";\n\nexport default function Payment() {\n  const stripe = useStripe();\n  const elements = useElements();\n  const dispatch = useDispatch();\n  const navigate = useNavigate();\n\n  const rawOrderInfo = sessionStorage.getItem(\"orderInfo\");\n  const orderInfo = rawOrderInfo ? JSON.parse(rawOrderInfo) : null;\n\n  const { user } = useSelector((state) => state.authState);\n  const { items: cartItems, shippingInfo } = useSelector((state) => state.cartState);\n  const {error:ordererror}=useSelector(state=>state.orderState);\n  useEffect(() => {\n    if (!orderInfo || !orderInfo.totalPrice) {\n      toast.error(\"Session expired or invalid order. Redirecting...\");\n      navigate(\"/cart\");\n      return;\n    }\n    validateShipping(shippingInfo, navigate);\n    if(ordererror){\n      toast(ordererror,{\n        type:\"error\",position:'bottom-center',onOpen:()=>{dispatch(clearorderError())}\n      })\n    }\n  }, [orderInfo, shippingInfo, navigate]);\n\n  if (!orderInfo || !orderInfo.totalPrice) return null;\n\n  const paymentData = {\n    amount: Math.round(orderInfo.totalPrice * 100),\n    shipping: {\n      name: user.name,\n      address: {\n        city: shippingInfo.city,\n        postal_code: shippingInfo.postalCode,\n        country: shippingInfo.country,\n        state: shippingInfo.state,\n        line1: shippingInfo.address\n      },\n      phone: shippingInfo.phoneno\n    }\n  };\n\n  const order = {\n    orderItems: cartItems,\n    shippingInfo,\n    itemsPrice: orderInfo.itemsPrice,\n    shippingPrice: orderInfo.shippingPrice,\n    taxPrice: orderInfo.taxPrice,\n    totalPrice: orderInfo.totalPrice\n  };\n\n  const onsubmitHandler = async (e) => {\n    e.preventDefault();\n    document.querySelector(\"#pay_btn\").disabled = true;\n\n    try {\n      const { data } = await axios.post(\"/api/v1/payment/process\", paymentData);\n      const clientSecret = data.client_secret;\n\n      const result = await stripe.confirmCardPayment(clientSecret, {\n        payment_method: {\n          card: elements.getElement(CardNumberElement),\n          billing_details: {\n            name: user.name,\n            email: user.email\n          }\n        }\n      });\n\n      if (result.error) {\n        toast(result.error.message, { position: \"bottom-center\", type: \"error\" });\n        document.querySelector(\"#pay_btn\").disabled = false;\n      } else {\n        if (result.paymentIntent.status === \"succeeded\") {\n          toast(\"Payment success!\", { type: \"success\", position: \"bottom-center\" });\n          order.paymentInfo={\n            id: result.paymentIntent.id,\n            status:result.paymentIntent.status\n          }\n        dispatch(createOrder(order))\n          navigate(\"/order/success\");\n        } else {\n          toast(\"Payment failed. Please try again.\", { type: \"warning\", position: \"bottom-center\" });\n        }\n      }\n    } catch (error) {\n      toast(error.response?.data?.message || \"Payment failed\", {\n        type: \"error\",\n        position: \"bottom-center\"\n      });\n      document.querySelector(\"#pay_btn\").disabled = false;\n    }\n  };\n\n  return (\n    <Fragment>\n      <MetaData title={\"Payment\"} />\n      <div className=\"row wrapper\">\n        <div className=\"col-10 col-lg-5\">\n          <form className=\"shadow-lg\" onSubmit={onsubmitHandler}>\n            <h1 className=\"mb-4\">Card Info</h1>\n\n            <div className=\"form-group\">\n              <label htmlFor=\"card_num_field\">Card Number</label>\n              <CardNumberElement id=\"card_num_field\" className=\"form-control\" />\n            </div>\n\n            <div className=\"form-group\">\n              <label htmlFor=\"card_exp_field\">Card Expiry</label>\n              <CardExpiryElement id=\"card_exp_field\" className=\"form-control\" />\n            </div>\n\n            <div className=\"form-group\">\n              <label htmlFor=\"card_cvc_field\">Card CVC</label>\n              <CardCvcElement id=\"card_cvc_field\" className=\"form-control\" />\n            </div>\n\n            <button id=\"pay_btn\" type=\"submit\" className=\"btn btn-block py-3\">\n              Pay - ${orderInfo.totalPrice}\n            </button>\n          </form>\n        </div>\n      </div>\n    </Fragment>\n  );\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}